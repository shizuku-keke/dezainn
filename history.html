<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>éå»ã®ä¼šè©±</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"/>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", Arial, "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif; background-color: #f0f2f5; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { display: flex; align-items: center; margin-bottom: 20px; }
    #back-button { background: none; border: none; font-size: 30px; cursor: pointer; color: #007bff; padding-right: 15px; }
    h1 { font-size: 24px; color: #333; }
    
    /* â–¼â–¼â–¼ æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  â–¼â–¼â–¼ */
    .search-container { margin-bottom: 20px; }
    #search-input {
      width: 100%;
      padding: 12px 15px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box; /* ã“ã‚Œã«ã‚ˆã‚ŠpaddingãŒwidthã«å«ã¾ã‚Œã‚‹ */
    }
    #search-input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    /* â–²â–²â–² æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  â–²â–²â–² */

    #history-list { display: flex; flex-direction: column; gap: 15px; }
    .history-item { display: flex; align-items: center; justify-content: space-between; padding: 20px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
    .history-item:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .history-link { display: flex; align-items: center; text-decoration: none; color: inherit; flex-grow: 1; overflow: hidden; }
    .member-icons { display: flex; flex-shrink: 0; margin-right: 15px; }
    .member-icon { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; margin-left: -12px; object-fit: cover; background-color: #ccc; }
    .member-icon:first-child { margin-left: 0; }
    .history-info { flex-grow: 1; overflow: hidden; }
    .history-info .member-names { font-weight: bold; margin-bottom: 5px; }
    .history-info .last-message-preview {
      font-size: 14px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .delete-button { background: none; border: none; font-size: 20px; color: #888; cursor: pointer; margin-left: 10px; }
    .delete-button:hover { color: #dc3545; }
    #no-history, #no-results { text-align: center; color: #888; margin-top: 40px; } /* â–¼â–¼â–¼ #no-results ã‚’è¿½åŠ  â–¼â–¼â–¼ */
    #clear-history-button { margin: 30px auto 0; display: block; padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <button id="back-button">â€¹</button>
      <h1>æˆ»ã‚‹</h1>
    </header>
    
    <!-- â–¼â–¼â–¼ æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ  â–¼â–¼â–¼ -->
    <div class="search-container">
      <input type="search" id="search-input" placeholder="å‚åŠ è€…åã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ¤œç´¢...">
    </div>
    <!-- â–²â–²â–² æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ  â–²â–²â–² -->
    
    <div id="history-list"></div>
    <p id="no-history" style="display: none;">ã¾ã ä¼šè©±ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    <!-- â–¼â–¼â–¼ æ¤œç´¢çµæœãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ  â–¼â–¼â–¼ -->
    <p id="no-results" style="display: none;">ä¸€è‡´ã™ã‚‹ä¼šè©±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
    <!-- â–²â–²â–² æ¤œç´¢çµæœãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ  â–²â–²â–² -->

    <button id="clear-history-button">ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤</button>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let users = {};
    let chatMeta = {};
    try {
        users = JSON.parse(localStorage.getItem('app_users') || '{}');
        chatMeta = JSON.parse(localStorage.getItem('chat_meta') || '{}');
    } catch(e) { console.error("ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—:", e); alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); return; }
    
    const historyList = document.getElementById('history-list');
    const noHistoryMsg = document.getElementById('no-history');
    const clearHistoryBtn = document.getElementById('clear-history-button');
    const searchContainer = document.querySelector('.search-container'); // â–¼â–¼â–¼ æ¤œç´¢ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾— â–¼â–¼â–¼

    document.getElementById('back-button').addEventListener('click', () => { window.location.href = 'index.html'; });

    const conversationList = Object.entries(chatMeta).map(([chatId, meta]) => ({ chatId, ...meta }));

    if (conversationList.length === 0) {
        noHistoryMsg.style.display = 'block';
        clearHistoryBtn.style.display = 'none';
        searchContainer.style.display = 'none'; // â–¼â–¼â–¼ ä¼šè©±ãŒãªã„å ´åˆã¯æ¤œç´¢ãƒãƒ¼ã‚‚éè¡¨ç¤ºã« â–¼â–¼â–¼
        return;
    }

    conversationList.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));

    conversationList.forEach(chatInfo => {
        const { chatId, members: memberIds, lastUpdated } = chatInfo;
        const memberNames = memberIds.map(id => users[id]?.name || 'ä¸æ˜').join('ã€');
        
        const item = document.createElement('div');
        item.className = 'history-item';
        item.id = `history-item-${chatId}`;

        const link = document.createElement('a');
        link.className = 'history-link';
        link.href = `history_view.html?chatId=${chatId}`;

        const iconsDiv = document.createElement('div');
        iconsDiv.className = 'member-icons';
        memberIds.slice(0, 4).forEach(id => {
            const icon = document.createElement('img');
            icon.className = 'member-icon';
            icon.src = users[id]?.icon || 'default-icon.png';
            iconsDiv.appendChild(icon);
        });

        const infoDiv = document.createElement('div');
        infoDiv.className = 'history-info';
        
        let previewText = 'ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“';
        const logData = JSON.parse(localStorage.getItem(`chat_log_${chatId}`) || '[]');
        if (logData.length > 0) {
            const lastLog = logData[logData.length - 1];
            if (lastLog.type === 'system') {
                previewText = `ï¼ˆ${lastLog.content}ï¼‰`;
            } else if (lastLog.type === 'text') {
                const speakerName = users[lastLog.speakerId]?.name || 'ä¸æ˜';
                previewText = `${speakerName}: ${lastLog.content}`;
            }
        }
        
        infoDiv.innerHTML = `
          <div class="member-names">${memberNames}ã•ã‚“ã®ä¼šè©±</div>
          <div class="last-message-preview">${previewText}</div>
        `;

        // â–¼â–¼â–¼ æ¤œç´¢ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’dataå±æ€§ã¨ã—ã¦ä¿å­˜ â–¼â–¼â–¼
        const searchableText = `${memberNames}ã•ã‚“ã®ä¼šè©± ${previewText}`;
        item.setAttribute('data-search-text', searchableText);
        // â–²â–²â–² æ¤œç´¢ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’dataå±æ€§ã¨ã—ã¦ä¿å­˜ â–²â–²â–²

        link.appendChild(iconsDiv);
        link.appendChild(infoDiv);
        item.appendChild(link);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-button';
        deleteBtn.innerHTML = 'ğŸ—‘ï¸';
        deleteBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!confirm(`ã€Œ${memberNames}ã•ã‚“ã®ä¼šè©±ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            localStorage.removeItem(`chat_log_${chatId}`);
            delete chatMeta[chatId];
            localStorage.setItem('chat_meta', JSON.stringify(chatMeta));
            item.remove();
            // â–¼â–¼â–¼ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çŠ¶æ…‹ã‚’æ›´æ–° â–¼â–¼â–¼
            filterConversations(); 
            if (Object.keys(chatMeta).length === 0) {
                noHistoryMsg.style.display = 'block';
                clearHistoryBtn.style.display = 'none';
                searchContainer.style.display = 'none';
            }
        });

        item.appendChild(deleteBtn);
        historyList.appendChild(item);
    });

    // â–¼â–¼â–¼ æ¤œç´¢æ©Ÿèƒ½ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼
    const searchInput = document.getElementById('search-input');
    const noResultsMsg = document.getElementById('no-results');

    function filterConversations() {
        const keyword = searchInput.value.toLowerCase().trim();
        const items = historyList.getElementsByClassName('history-item');
        let visibleCount = 0;

        Array.from(items).forEach(item => {
            const searchText = item.getAttribute('data-search-text').toLowerCase();
            if (searchText.includes(keyword)) {
                item.style.display = 'flex';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        noResultsMsg.style.display = (visibleCount === 0 && keyword !== '') ? 'block' : 'none';
    }

    searchInput.addEventListener('input', filterConversations);
    // â–²â–²â–² æ¤œç´¢æ©Ÿèƒ½ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  â–²â–²â–²

    clearHistoryBtn.addEventListener('click', () => {
        if (!confirm('ã™ã¹ã¦ã®ä¼šè©±è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        Object.keys(chatMeta).forEach(chatId => { localStorage.removeItem(`chat_log_${chatId}`); });
        localStorage.removeItem('chat_meta');
        alert('ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        location.reload();
    });
});
</script>
</body>
</html>